# =============================================================================
# ğŸ§ª Nextest é…ç½®æ–‡ä»¶ - ä¼˜åŒ–ç‰ˆ
# =============================================================================
# è¯¦ç»†æ–‡æ¡£: https://nexte.st/docs/configuration/
# é…ç½®å‚è€ƒ: https://nexte.st/docs/configuration/configuration-reference

[profile.default]
# æœ¬åœ°å¼€å‘é»˜è®¤é…ç½®
retries = 0
test-threads = "num-cpus"
slow-timeout = { period = "60s", terminate-after = 2 }
leak-timeout = "100ms"
fail-fast = false                    # æ˜¾ç¤ºæ‰€æœ‰æµ‹è¯•ç»“æœ

# è¾“å‡ºæ§åˆ¶ - æœ¬åœ°å¼€å‘æ—¶å‡å°‘å™ªéŸ³
success-output = "never"             # æˆåŠŸæµ‹è¯•ä¸æ˜¾ç¤ºè¾“å‡º
failure-output = "immediate"         # å¤±è´¥æµ‹è¯•ç«‹å³æ˜¾ç¤º
status-level = "retry"               # åªæ˜¾ç¤ºé‡è¯•å’Œå¤±è´¥

# CI ç¯å¢ƒä¸“ç”¨é…ç½®
[profile.ci]
# é‡è¯•å¤±è´¥çš„æµ‹è¯•ä»¥å‡å°‘å› ç½‘ç»œç­‰é—®é¢˜å¯¼è‡´çš„å‡é˜³æ€§
retries = 2

# CI ç¯å¢ƒé€šå¸¸èµ„æºæœ‰é™ï¼Œä½¿ç”¨ä¿å®ˆçš„çº¿ç¨‹æ•°
# é¿å…èµ„æºç«äº‰å¯¼è‡´çš„ä¸ç¨³å®š
test-threads = 2

# CI ç¯å¢ƒä¸­æµ‹è¯•å¯èƒ½æ›´æ…¢ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
slow-timeout = { period = "120s", terminate-after = 3 }
leak-timeout = "500ms"

# CI éœ€è¦å¿«é€Ÿå¤±è´¥ä»¥èŠ‚çœæ—¶é—´å’Œèµ„æº
fail-fast = true

# CI è¾“å‡ºæ§åˆ¶ - éœ€è¦è¯¦ç»†ä¿¡æ¯ç”¨äºè°ƒè¯•
success-output = "immediate"         # æ˜¾ç¤ºæ‰€æœ‰è¾“å‡ºä¾¿äºè°ƒè¯•
failure-output = "immediate"         # å¤±è´¥ç«‹å³æ˜¾ç¤º
status-level = "pass"                # æ˜¾ç¤ºé€šè¿‡çš„æµ‹è¯•
final-status-level = "flaky"         # æ˜¾ç¤ºä¸ç¨³å®šçš„æµ‹è¯•

# JUnit æŠ¥å‘Šé…ç½® - CI ç³»ç»Ÿé›†æˆ
[profile.ci.junit]
path = "junit.xml"                   # JUnit XML æŠ¥å‘Šè·¯å¾„

# å¼€å‘ç¯å¢ƒå¿«é€Ÿæµ‹è¯•é…ç½®
[profile.quick]
retries = 0
test-threads = "num-cpus"
slow-timeout = { period = "30s", terminate-after = 1 }
# åªè¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼Œè·³è¿‡æ ‡è®°ä¸º slow çš„æµ‹è¯•
filter = 'not test(slow)'
# å¿«é€Ÿå¤±è´¥ï¼Œæé«˜å¼€å‘æ•ˆç‡
fail-fast = true

# è¾“å‡ºæ§åˆ¶ - å¿«é€ŸéªŒè¯æ—¶å‡å°‘å™ªéŸ³
success-output = "never"
failure-output = "immediate"
status-level = "fail"                # åªæ˜¾ç¤ºå¤±è´¥

# è¦†ç›–ç‡æµ‹è¯•é…ç½®
[profile.coverage]
retries = 0
test-threads = 1                     # å•çº¿ç¨‹ç¡®ä¿è¦†ç›–ç‡æ•°æ®å‡†ç¡®
slow-timeout = { period = "300s", terminate-after = 1 }
# è¦†ç›–ç‡æµ‹è¯•éœ€è¦å®Œæ•´è¿è¡Œï¼Œä¸ä½¿ç”¨ fail-fast
fail-fast = false

# è¦†ç›–ç‡è¾“å‡ºæ§åˆ¶
success-output = "never"
failure-output = "immediate"
status-level = "pass"                # æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯

# å¿«é€Ÿå¤±è´¥é…ç½® - ç”¨äºæœ¬åœ°å¿«é€ŸéªŒè¯
[profile.fast-fail]
retries = 0
test-threads = "num-cpus"
slow-timeout = { period = "10s", terminate-after = 1 }
fail-fast = true
# åªæ˜¾ç¤ºå¤±è´¥ä¿¡æ¯ï¼Œå‡å°‘è¾“å‡º
success-output = "never"
failure-output = "immediate"
status-level = "fail"                # åªæ˜¾ç¤ºå¤±è´¥ï¼Œæœ€å°‘å™ªéŸ³

# è°ƒè¯•é…ç½® - å•çº¿ç¨‹è¯¦ç»†è¾“å‡º
[profile.debug]
retries = 0
test-threads = 1                     # å•çº¿ç¨‹ä¾¿äºè°ƒè¯•
slow-timeout = { period = "600s", terminate-after = 1 }  # é•¿è¶…æ—¶æ”¯æŒæ–­ç‚¹è°ƒè¯•
fail-fast = true                     # é‡åˆ°é—®é¢˜ç«‹å³åœæ­¢
leak-timeout = "1s"                  # æ›´å®½æ¾çš„å†…å­˜æ³„æ¼æ£€æµ‹

# è°ƒè¯•è¾“å‡º - æ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯
success-output = "immediate"
failure-output = "immediate"
status-level = "all"                 # æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€ä¿¡æ¯
final-status-level = "all"

# å‹åŠ›æµ‹è¯•é…ç½® - ç”¨äºå‘ç°ç«æ€æ¡ä»¶ç­‰é—®é¢˜
[profile.stress]
retries = 0
# æ•…æ„è¿‡è½½ä»¥å‘ç°å¹¶å‘é—®é¢˜
test-threads = 16
slow-timeout = { period = "180s", terminate-after = 1 }
fail-fast = false                    # è¿è¡Œæ‰€æœ‰æµ‹è¯•å‘ç°æ‰€æœ‰é—®é¢˜

# å‹åŠ›æµ‹è¯•è¾“å‡º
success-output = "never"
failure-output = "immediate"
status-level = "retry"               # æ˜¾ç¤ºé‡è¯•å’Œå¤±è´¥

# æ€§èƒ½åŸºå‡†æµ‹è¯•é…ç½®
[profile.bench]
retries = 0
test-threads = 1                     # å•çº¿ç¨‹ç¡®ä¿åŸºå‡†æµ‹è¯•å‡†ç¡®æ€§
slow-timeout = { period = "600s", terminate-after = 1 }  # åŸºå‡†æµ‹è¯•å¯èƒ½å¾ˆæ…¢
fail-fast = false

# åŸºå‡†æµ‹è¯•è¾“å‡º
success-output = "immediate"
failure-output = "immediate"
status-level = "pass"

# =============================================================================
# ä½¿ç”¨è¯´æ˜
# =============================================================================
#
# æ—¥å¸¸ä½¿ç”¨ï¼š
#   cargo nextest run                    # é»˜è®¤é…ç½®
#   cargo nextest run --profile quick    # å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢æµ‹è¯•ï¼‰
#   cargo nextest run --profile fast-fail # æé€ŸéªŒè¯ï¼ˆ10ç§’è¶…æ—¶ï¼‰
#
# CI/CD ç¯å¢ƒï¼š
#   cargo nextest run --profile ci       # CI é…ç½®ï¼ˆåŒ…å« JUnit æŠ¥å‘Šï¼‰
#
# å¼€å‘è°ƒè¯•ï¼š
#   cargo nextest run --profile debug    # å•çº¿ç¨‹è°ƒè¯•
#   cargo nextest run --profile stress   # å‹åŠ›æµ‹è¯•
#
# ä»£ç è´¨é‡ï¼š
#   cargo nextest run --profile coverage # è¦†ç›–ç‡æµ‹è¯•
#   cargo nextest run --profile bench    # æ€§èƒ½åŸºå‡†æµ‹è¯•
#
# ç¯å¢ƒå˜é‡è¦†ç›–ï¼š
#   NEXTEST_RETRIES=3 cargo nextest run
#   NEXTEST_TEST_THREADS=8 cargo nextest run --profile quick
