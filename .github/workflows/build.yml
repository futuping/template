name: ci-cd

on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
    branches:
      - main
  # æ–°å¢ï¼šCodeQL å®Œæˆåä¹Ÿå¯ä»¥è§¦å‘ï¼ˆç”¨äºä¸²è¡Œæ¨¡å¼ï¼‰
  workflow_run:
    workflows: ["CodeQL å®‰å…¨åˆ†æ"]
    types:
      - completed
    branches:
      - main
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  workflow_dispatch:

permissions:
  contents: write

# ç¯å¢ƒå˜é‡
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # é«˜çº§å®‰å…¨å®¡è®¡ (pre-commit æœªè¦†ç›–çš„é«˜çº§åŠŸèƒ½)
  security-audit:
    name: ğŸ›¡ï¸ ä¾èµ–æ¼æ´å®¡è®¡
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…å®‰å…¨å®¡è®¡å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Rust ä¾èµ–æ¼æ´å®¡è®¡
        run: cargo audit

  # æµ‹è¯•ä½œä¸š - æ”¯æŒå¤šå¹³å° (pre-commit å·²å¤„ç†åŸºç¡€æ£€æŸ¥ï¼Œè¿™é‡Œä¸“æ³¨æµ‹è¯•å’Œè¦†ç›–ç‡)
  test:
    name: ğŸ§ª æµ‹è¯• (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable --component llvm-tools-preview
          rustup default stable

      - name: å®‰è£…æµ‹è¯•å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest,cargo-llvm-cov

      - uses: Swatinem/rust-cache@v2
        with:
          key: test-${{ matrix.os }}-${{ matrix.target }}

      - name: è¿è¡Œæµ‹è¯•
        run: cargo nextest run --all-features

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo llvm-cov nextest --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --html --output-dir coverage-html

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false

      - name: ä¸Šä¼ è¦†ç›–ç‡ HTML æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-html

  # ç‰¹æ®Šå¹³å°æ„å»ºä½œä¸š (macOS)
  special-build:
    name: ğŸ macOS æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            experimental: false
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            experimental: false

    runs-on: ${{ matrix.os }}
    needs: [security-audit]
    continue-on-error: ${{ matrix.experimental }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable
          rustup default stable

      - name: æ·»åŠ ç›®æ ‡å¹³å°
        run: rustup target add ${{ matrix.target }}

      - name: è®¾ç½® macOS å¼€å‘ç¯å¢ƒ
        if: matrix.platform == 'macos'
        run: |
          echo "é…ç½® macOS åŸç”Ÿæ„å»ºç¯å¢ƒ"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.target }}"
          # å®‰è£…å¿…è¦çš„ macOS å¼€å‘å·¥å…·
          xcode-select --install || true

      - uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ matrix.os }}-${{ matrix.target }}

      - name: æ„å»º macOS é¡¹ç›®
        run: cargo build --release --target ${{ matrix.target }}

      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/

  # ä»£ç è´¨é‡åˆ†æ (pre-commit å·²å¤„ç†åŸºç¡€æ£€æŸ¥ï¼Œè¿™é‡Œä¸“æ³¨é«˜çº§åˆ†æ)
  quality-analysis:
    name: ğŸ“Š ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€å’Œå‘å¸ƒæ—¶è¿›è¡Œå®Œæ•´è´¨é‡åˆ†æï¼ŒPR è·³è¿‡ä»¥æé«˜æ•ˆç‡
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…åˆ†æå·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete

      - name: æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
        run: cargo machete

      - name: ç”Ÿæˆä¾èµ–å›¾
        run: |
          cargo tree --format "{p} {f}" > dependency-tree.txt
          echo "ä¾èµ–æ ‘å·²ç”Ÿæˆ"

      - name: ä¸Šä¼ ä¾èµ–åˆ†æç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: dependency-tree.txt

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-review:
    name: ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

  # å‘å¸ƒä½œä¸š
  release:
    name: ğŸš€ åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [security-audit, test, special-build, quality-analysis]
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: ç­‰å¾… CodeQL å®‰å…¨åˆ†æå®Œæˆï¼ˆä¸²è¡Œå‘å¸ƒç­–ç•¥ï¼‰
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” å®æ–½ä¸²è¡Œå‘å¸ƒç­–ç•¥ï¼šç­‰å¾… CodeQL å®‰å…¨åˆ†æå®Œæˆ...');

            // å¦‚æœæ˜¯é€šè¿‡ workflow_run è§¦å‘ï¼ŒCodeQL å·²ç»æˆåŠŸ
            if (context.eventName === 'workflow_run') {
              console.log('âœ… é€šè¿‡ workflow_run è§¦å‘ï¼ŒCodeQL å·²ç»æˆåŠŸå®Œæˆ');
              return;
            }

            // å¦åˆ™éœ€è¦ä¸»åŠ¨ç­‰å¾… CodeQL å®Œæˆ
            const maxWaitTime = 20 * 60 * 1000; // 20åˆ†é’Ÿ
            const checkInterval = 30 * 1000;    // 30ç§’æ£€æŸ¥ä¸€æ¬¡
            const startTime = Date.now();

            console.log('â³ å¼€å§‹ç­‰å¾… CodeQL åˆ†æå®Œæˆï¼ˆæœ€é•¿ç­‰å¾…20åˆ†é’Ÿï¼‰...');

            while (Date.now() - startTime < maxWaitTime) {
              try {
                // è·å–å½“å‰æäº¤çš„æ‰€æœ‰å·¥ä½œæµè¿è¡Œ
                const { data: allRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head_sha: context.sha,
                  per_page: 50
                });

                // æŸ¥æ‰¾ CodeQL å·¥ä½œæµ
                const codeqlRuns = allRuns.workflow_runs.filter(run =>
                  run.name === 'CodeQL å®‰å…¨åˆ†æ' || run.path === '.github/workflows/codeql.yml'
                );

                if (codeqlRuns.length > 0) {
                  const latestRun = codeqlRuns[0];
                  console.log(`ğŸ“Š CodeQL çŠ¶æ€: ${latestRun.status}, ç»“è®º: ${latestRun.conclusion || 'è¿›è¡Œä¸­'}`);

                  if (latestRun.status === 'completed') {
                    if (latestRun.conclusion === 'success') {
                      console.log('âœ… CodeQL å®‰å…¨åˆ†ææˆåŠŸå®Œæˆï¼Œç»§ç»­å‘å¸ƒæµç¨‹');
                      return;
                    } else if (latestRun.conclusion === 'failure') {
                      core.setFailed('âŒ CodeQL å®‰å…¨åˆ†æå¤±è´¥ï¼Œå‘å¸ƒå·²ç»ˆæ­¢');
                      return;
                    } else {
                      console.log(`â„¹ï¸ CodeQL å®Œæˆä½†ç»“è®ºä¸º: ${latestRun.conclusion}ï¼Œç»§ç»­å‘å¸ƒ`);
                      return;
                    }
                  }
                }

                // ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                console.log(`â³ ç­‰å¾…ä¸­... (å·²ç­‰å¾… ${elapsed}s)`);
                await new Promise(resolve => setTimeout(resolve, checkInterval));

              } catch (error) {
                console.log(`âš ï¸ æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, checkInterval));
              }
            }

            console.log('â° ç­‰å¾…è¶…æ—¶ï¼Œä½†ç»§ç»­å‘å¸ƒæµç¨‹ï¼ˆé¿å…é˜»å¡ï¼‰');
            core.warning('CodeQL ç­‰å¾…è¶…æ—¶ï¼Œä½†ç»§ç»­å‘å¸ƒæµç¨‹');

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4

      - name: è°ƒè¯•æ–‡ä»¶ç»“æ„
        run: |
          echo "ğŸ“‹ ä¸‹è½½åçš„æ–‡ä»¶ç»“æ„:"
          find . -name "macos-*" -type d | head -10
          echo ""
          echo "ğŸ“„ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨:"
          find . -name "macos-*" -type d -exec ls -la {} \;

      - name: ç»„ç»‡å‘å¸ƒæ–‡ä»¶ç»“æ„
        run: |
          mkdir -p releases/macos

          # æ•´ç† macOS å¹³å°æ–‡ä»¶ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹ç›®å½•
          find . -name "macos-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              echo "ğŸ“ å¤„ç†ç›®å½•: $dir"
              # å¤åˆ¶åˆ°ç»Ÿä¸€ç›®å½•ç”¨äºæ‰“åŒ…
              cp -r "$dir"/* releases/macos/ 2>/dev/null || true
              # é‡å‘½åå•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ä»¥ä¾¿ä¸Šä¼ 
              if [ -f "$dir/template" ]; then
                target_name=$(basename "$dir")
                cp "$dir/template" "template-${target_name#macos-}"
                echo "âœ… åˆ›å»ºå•ç‹¬äºŒè¿›åˆ¶: template-${target_name#macos-}"
              fi
            fi
          done

          echo ""
          echo "ğŸ“‹ æœ€ç»ˆæ–‡ä»¶ç»“æ„:"
          ls -la
          echo ""
          echo "ğŸ“¦ releases/macos å†…å®¹:"
          ls -la releases/macos/ 2>/dev/null || echo "ç›®å½•ä¸ºç©º"

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        uses: orhun/git-cliff-action@v2
        id: git-cliff
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ğŸš€ macOS å‘å¸ƒ

          æœ¬ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹å¹³å°ï¼š

          ### ğŸ macOS å¹³å°
          - **macOS Apple Silicon**: åŸç”Ÿæ”¯æŒ (aarch64-apple-darwin)
          - **macOS Intel**: åŸç”Ÿæ”¯æŒ (x86_64-apple-darwin)

          ---

          EOF
          cat CHANGES.md >> RELEASE_NOTES.md

      - name: åˆ›å»ºè·¨å¹³å°å‘å¸ƒåŒ…
        run: |
          cd releases

          # åˆ›å»º macOS å¹³å°å‘å¸ƒåŒ…
          if [ -d "macos" ] && [ "$(ls -A macos)" ]; then
            echo "ğŸ“¦ åˆ›å»º macOS å‘å¸ƒåŒ…..."
            tar -czf ../template-macos-universal.tar.gz macos/
            echo "âœ… macOS å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ: template-macos-universal.tar.gz"
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° macOS æ„å»ºäº§ç‰©"
          fi

          # æ˜¾ç¤ºå‘å¸ƒåŒ…ä¿¡æ¯
          cd ..
          echo "ğŸ“‹ å‘å¸ƒåŒ…åˆ—è¡¨:"
          ls -lh *.tar.gz 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å‘å¸ƒåŒ…"

      - name: åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            template-macos-universal.tar.gz
            template-aarch64-apple-darwin
            template-x86_64-apple-darwin
          draft: false
          prerelease: false
          name: "Release ${{ github.ref_name }} - macOS æ”¯æŒ"
