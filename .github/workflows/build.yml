name: build

on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
    branches:
      - main

permissions:
  contents: write

# ç¯å¢ƒå˜é‡
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # é«˜çº§å®‰å…¨å®¡è®¡ (pre-commit æœªè¦†ç›–çš„é«˜çº§åŠŸèƒ½)
  security-audit:
    name: ğŸ›¡ï¸ ä¾èµ–æ¼æ´å®¡è®¡
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£…å®‰å…¨å®¡è®¡å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Rust ä¾èµ–æ¼æ´å®¡è®¡
        run: cargo audit

  # æµ‹è¯•ä½œä¸š - æ”¯æŒå¤šå¹³å° (pre-commit å·²å¤„ç†åŸºç¡€æ£€æŸ¥ï¼Œè¿™é‡Œä¸“æ³¨æµ‹è¯•å’Œè¦†ç›–ç‡)
  test:
    name: ğŸ§ª æµ‹è¯• (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable --component llvm-tools-preview
          rustup default stable

      - name: å®‰è£…æµ‹è¯•å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest,cargo-llvm-cov

      - uses: Swatinem/rust-cache@v2
        with:
          key: test-${{ matrix.os }}-${{ matrix.target }}

      - name: è¿è¡Œæµ‹è¯•
        run: cargo nextest run --all-features

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo llvm-cov nextest --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --html --output-dir coverage-html

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false

      - name: ä¸Šä¼ è¦†ç›–ç‡ HTML æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-html

  # ç‰¹æ®Šå¹³å°æ„å»ºä½œä¸š (macOS)
  special-build:
    name: ğŸ macOS æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            experimental: false
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            experimental: false

    runs-on: ${{ matrix.os }}
    needs: [security-audit]
    continue-on-error: ${{ matrix.experimental }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable
          rustup default stable

      - name: æ·»åŠ ç›®æ ‡å¹³å°
        run: rustup target add ${{ matrix.target }}

      - name: è®¾ç½® macOS å¼€å‘ç¯å¢ƒ
        if: matrix.platform == 'macos'
        run: |
          echo "é…ç½® macOS åŸç”Ÿæ„å»ºç¯å¢ƒ"
          echo "ç›®æ ‡æ¶æ„: ${{ matrix.target }}"
          # å®‰è£…å¿…è¦çš„ macOS å¼€å‘å·¥å…·
          xcode-select --install || true

      - uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ matrix.os }}-${{ matrix.target }}

      - name: æ„å»º macOS é¡¹ç›®
        run: cargo build --release --target ${{ matrix.target }}

      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/

  # ä»£ç è´¨é‡åˆ†æ (pre-commit å·²å¤„ç†åŸºç¡€æ£€æŸ¥ï¼Œè¿™é‡Œä¸“æ³¨é«˜çº§åˆ†æ)
  quality-analysis:
    name: ğŸ“Š ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€å’Œå‘å¸ƒæ—¶è¿›è¡Œå®Œæ•´è´¨é‡åˆ†æï¼ŒPR è·³è¿‡ä»¥æé«˜æ•ˆç‡
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…åˆ†æå·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete

      - name: æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
        run: cargo machete

      - name: ç”Ÿæˆä¾èµ–å›¾
        run: |
          cargo tree --format "{p} {f}" > dependency-tree.txt
          echo "ä¾èµ–æ ‘å·²ç”Ÿæˆ"

      - name: ä¸Šä¼ ä¾èµ–åˆ†æç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: dependency-tree.txt

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-review:
    name: ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

  # å‘å¸ƒä½œä¸š
  release:
    name: ğŸš€ åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [security-audit, test, special-build, quality-analysis]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ç­‰å¾… CodeQL å®‰å…¨åˆ†æå®Œæˆ
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” æ£€æŸ¥ CodeQL å®‰å…¨åˆ†æçŠ¶æ€...');

            try {
              // è·å–å½“å‰æäº¤çš„æ‰€æœ‰å·¥ä½œæµè¿è¡Œ
              const { data: allRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: context.sha,
                per_page: 50
              });

              console.log(`ğŸ“‹ æ‰¾åˆ° ${allRuns.workflow_runs.length} ä¸ªå·¥ä½œæµè¿è¡Œ`);

              // æŸ¥æ‰¾ CodeQL å·¥ä½œæµ
              const codeqlRuns = allRuns.workflow_runs.filter(run =>
                run.name === 'CodeQL å®‰å…¨åˆ†æ' || run.path === '.github/workflows/codeql.yml'
              );

              console.log(`ğŸ” æ‰¾åˆ° ${codeqlRuns.length} ä¸ª CodeQL å·¥ä½œæµè¿è¡Œ`);

              if (codeqlRuns.length === 0) {
                console.log('âš ï¸ æœªæ‰¾åˆ° CodeQL å·¥ä½œæµè¿è¡Œï¼Œå¯èƒ½è¿˜æœªå¼€å§‹');
                console.log('ğŸ’¡ è·³è¿‡ CodeQL æ£€æŸ¥ï¼Œç»§ç»­å‘å¸ƒæµç¨‹');
                return;
              }

              const latestCodeqlRun = codeqlRuns[0];
              console.log(`ğŸ“Š æœ€æ–° CodeQL è¿è¡ŒçŠ¶æ€: ${latestCodeqlRun.status}`);
              console.log(`ğŸ“Š è¿è¡Œç»“è®º: ${latestCodeqlRun.conclusion || 'è¿›è¡Œä¸­'}`);

              // æ£€æŸ¥è¿è¡ŒçŠ¶æ€
              if (latestCodeqlRun.status !== 'completed') {
                console.log('â³ CodeQL åˆ†æä»åœ¨è¿›è¡Œä¸­');
                console.log('ğŸ’¡ è·³è¿‡ç­‰å¾…ï¼Œç»§ç»­å‘å¸ƒæµç¨‹');
                return;
              }

              // æ£€æŸ¥è¿è¡Œç»“æœ
              if (latestCodeqlRun.conclusion === 'failure') {
                core.setFailed('âŒ CodeQL å®‰å…¨åˆ†æå‘ç°é—®é¢˜ï¼Œå‘å¸ƒå·²æš‚åœ');
                return;
              }

              if (latestCodeqlRun.conclusion === 'success') {
                console.log('âœ… CodeQL å®‰å…¨åˆ†ææˆåŠŸå®Œæˆ');
              } else {
                console.log(`â„¹ï¸ CodeQL åˆ†æå®Œæˆï¼Œç»“è®º: ${latestCodeqlRun.conclusion}`);
              }

            } catch (error) {
              console.log(`âš ï¸ æ£€æŸ¥ CodeQL çŠ¶æ€æ—¶å‡ºé”™: ${error.message}`);
              console.log('ğŸ’¡ è·³è¿‡ CodeQL æ£€æŸ¥ï¼Œç»§ç»­å‘å¸ƒæµç¨‹');
            }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4

      - name: ç»„ç»‡å‘å¸ƒæ–‡ä»¶ç»“æ„
        run: |
          mkdir -p releases/macos

          # æ•´ç† macOS å¹³å°æ–‡ä»¶
          find . -name "macos-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* releases/macos/ 2>/dev/null || true
            fi
          done

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        uses: orhun/git-cliff-action@v2
        id: git-cliff
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ğŸš€ macOS å‘å¸ƒ

          æœ¬ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹å¹³å°ï¼š

          ### ğŸ macOS å¹³å°
          - **macOS Apple Silicon**: åŸç”Ÿæ”¯æŒ (aarch64-apple-darwin)
          - **macOS Intel**: åŸç”Ÿæ”¯æŒ (x86_64-apple-darwin)

          ---

          EOF
          cat CHANGES.md >> RELEASE_NOTES.md

      - name: åˆ›å»ºè·¨å¹³å°å‘å¸ƒåŒ…
        run: |
          cd releases

          # åˆ›å»º macOS å¹³å°å‘å¸ƒåŒ…
          if [ -d "macos" ] && [ "$(ls -A macos)" ]; then
            echo "ğŸ“¦ åˆ›å»º macOS å‘å¸ƒåŒ…..."
            tar -czf ../template-macos-universal.tar.gz macos/
            echo "âœ… macOS å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ: template-macos-universal.tar.gz"
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° macOS æ„å»ºäº§ç‰©"
          fi

          # æ˜¾ç¤ºå‘å¸ƒåŒ…ä¿¡æ¯
          cd ..
          echo "ğŸ“‹ å‘å¸ƒåŒ…åˆ—è¡¨:"
          ls -lh *.tar.gz 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å‘å¸ƒåŒ…"

      - name: åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            template-macos-universal.tar.gz
            macos-*/template
          draft: false
          prerelease: false
          name: "Release ${{ github.ref_name }} - macOS æ”¯æŒ"
