name: build

on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
    branches:
      - main

permissions:
  contents: write

# ç¯å¢ƒå˜é‡
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # å®‰å…¨æ£€æŸ¥ä½œä¸š
  security:
    name: ğŸ”’ å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: å®‰è£…å®‰å…¨æ£€æŸ¥å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: æ£€æµ‹ç¡¬ç¼–ç å¯†é’¥å’Œæ•æ„Ÿä¿¡æ¯
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Rust ä¾èµ–æ¼æ´å®¡è®¡
        run: cargo audit

  # å·¥ä½œæµéªŒè¯ä½œä¸š
  workflow-validation:
    name: ğŸ“Š å·¥ä½œæµéªŒè¯
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: éªŒè¯ YAML è¯­æ³•
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120

  # ä»£ç è´¨é‡æ£€æŸ¥ä½œä¸š
  checks:
    name: ğŸ¦€ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable --component rustfmt,clippy
          rustup default stable

      - name: å®‰è£…é™„åŠ å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,typos-cli

      - uses: Swatinem/rust-cache@v2
        with:
          key: checks

      - name: æ£€æŸ¥ä»£ç æ ¼å¼
        run: cargo fmt -- --check

      - name: æ‹¼å†™æ£€æŸ¥
        run: typos --format brief

      - name: å®‰å…¨å’Œè®¸å¯è¯æ£€æŸ¥
        run: cargo deny check

      - name: æ£€æŸ¥ä»£ç é”™è¯¯
        run: cargo check --all-targets --all-features

      - name: Clippy ä¸¥æ ¼ä»£ç æ£€æŸ¥
        run: |
          cargo clippy --all-targets --all-features --tests --benches -- \
          -D warnings \
          -D clippy::all \
          -D clippy::pedantic \
          -D clippy::cognitive_complexity \
          -D clippy::too_many_lines \
          -A clippy::module_name_repetitions

      - name: æ–‡æ¡£ç”Ÿæˆæ£€æŸ¥
        run: cargo doc --no-deps --document-private-items --all-features

      - name: æ–‡æ¡£æµ‹è¯•
        run: cargo test --doc --all-features

  # æµ‹è¯•ä½œä¸š - æ”¯æŒå¤šå¹³å°
  test:
    name: ğŸ§ª æµ‹è¯• (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.os }}
    needs: [security, workflow-validation, checks]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable --component llvm-tools-preview
          rustup default stable

      - name: å®‰è£…æµ‹è¯•å·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest,cargo-llvm-cov

      - uses: Swatinem/rust-cache@v2
        with:
          key: test-${{ matrix.target }}

      - name: è¿è¡Œæµ‹è¯•
        run: cargo nextest run --all-features --profile ci

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo llvm-cov nextest --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --html --output-dir coverage-html

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false

      - name: ä¸Šä¼ è¦†ç›–ç‡ HTML æŠ¥å‘Š (ä»…é™ Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage-html

  # åŸºå‡†æµ‹è¯•ä½œä¸š
  benchmark:
    name: ğŸ“ˆ åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    needs: checks
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: benchmark

      - name: è¿è¡ŒåŸºå‡†æµ‹è¯•
        run: cargo bench --bench '*' || echo "æ²¡æœ‰é…ç½®åŸºå‡†æµ‹è¯•"

  # æ¡Œé¢å¹³å°æ„å»ºä½œä¸š
  desktop-build:
    name: ğŸ–¥ï¸ æ¡Œé¢å¹³å°æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux å¹³å°
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use-cross: false
            platform: linux
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use-cross: true
            platform: linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use-cross: true
            platform: linux
          - os: ubuntu-latest
            target: i686-unknown-linux-gnu
            use-cross: true
            platform: linux
          
          # Windows å¹³å°
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use-cross: false
            platform: windows
          - os: windows-latest
            target: i686-pc-windows-msvc
            use-cross: false
            platform: windows
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            use-cross: true
            platform: windows
          
          # macOS å¹³å°
          - os: macos-latest
            target: x86_64-apple-darwin
            use-cross: false
            platform: macos
          - os: macos-latest
            target: aarch64-apple-darwin
            use-cross: false
            platform: macos

    runs-on: ${{ matrix.os }}
    needs: [security, workflow-validation, checks, test]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable
          rustup target add ${{ matrix.target }}
          rustup default stable

      - name: å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·
        if: matrix.use-cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: å®‰è£… Windows é¢å¤–å·¥å…·é“¾
        if: matrix.platform == 'windows' && matrix.target == 'x86_64-pc-windows-gnu'
        run: |
          rustup toolchain install stable-x86_64-pc-windows-gnu
          rustup target add x86_64-pc-windows-gnu

      - uses: Swatinem/rust-cache@v2
        with:
          key: desktop-${{ matrix.target }}

      - name: æ„å»ºé¡¹ç›® (äº¤å‰ç¼–è¯‘)
        if: matrix.use-cross
        run: cross build --release --target ${{ matrix.target }}

      - name: æ„å»ºé¡¹ç›® (æœ¬åœ°ç¼–è¯‘)
        if: '!matrix.use-cross'
        run: cargo build --release --target ${{ matrix.target }}

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            7z a ../../../${{ github.event.repository.name }}-${{ matrix.target }}.zip ${{ github.event.repository.name }}.exe
          else
            tar czvf ../../../${{ github.event.repository.name }}-${{ matrix.target }}.tar.gz ${{ github.event.repository.name }}
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: desktop-${{ matrix.target }}
          path: |
            ${{ github.event.repository.name }}-${{ matrix.target }}.*

  # ç§»åŠ¨å¹³å°æ„å»ºä½œä¸š
  mobile-build:
    name: ğŸ“± ç§»åŠ¨å¹³å°æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # iOS å¹³å°
          - os: macos-latest
            target: aarch64-apple-ios
            platform: ios
            sdk: iphoneos
          - os: macos-latest
            target: x86_64-apple-ios
            platform: ios
            sdk: iphonesimulator
          - os: macos-latest
            target: aarch64-apple-ios-sim
            platform: ios
            sdk: iphonesimulator
          
          # Android å¹³å°
          - os: ubuntu-latest
            target: aarch64-linux-android
            platform: android
            arch: arm64-v8a
          - os: ubuntu-latest
            target: armv7-linux-androideabi
            platform: android
            arch: armeabi-v7a
          - os: ubuntu-latest
            target: x86_64-linux-android
            platform: android
            arch: x86_64
          - os: ubuntu-latest
            target: i686-linux-android
            platform: android
            arch: x86

    runs-on: ${{ matrix.os }}
    needs: [security, workflow-validation, checks]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable
          rustup target add ${{ matrix.target }}
          rustup default stable

      # iOS ç‰¹å®šè®¾ç½®
      - name: è®¾ç½® iOS å¼€å‘ç¯å¢ƒ
        if: matrix.platform == 'ios'
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcrun --sdk ${{ matrix.sdk }} --show-sdk-path

      # Android ç‰¹å®šè®¾ç½®
      - name: è®¾ç½® Android å¼€å‘ç¯å¢ƒ
        if: matrix.platform == 'android'
        run: |
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          
      - name: å®‰è£… Android NDK å·¥å…·é“¾
        if: matrix.platform == 'android'
        run: |
          rustup toolchain install stable
          # è®¾ç½® NDK é“¾æ¥å™¨
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          
          [target.armv7-linux-androideabi]
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
          
          [target.x86_64-linux-android]
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
          
          [target.i686-linux-android]
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang"
          EOF

      - uses: Swatinem/rust-cache@v2
        with:
          key: mobile-${{ matrix.target }}

      - name: æ„å»ºç§»åŠ¨å¹³å°é¡¹ç›®
        run: cargo build --release --target ${{ matrix.target }}

      - name: åˆ›å»ºç§»åŠ¨å¹³å°å‘å¸ƒåŒ…
        shell: bash
        run: |
          mkdir -p mobile-releases/${{ matrix.platform }}
          cd target/${{ matrix.target }}/release
          if [[ "${{ matrix.platform }}" == "ios" ]]; then
            # iOS é™æ€åº“
            cp lib${{ github.event.repository.name }}.a ../../../mobile-releases/${{ matrix.platform }}/lib${{ github.event.repository.name }}-${{ matrix.target }}.a
          elif [[ "${{ matrix.platform }}" == "android" ]]; then
            # Android å…±äº«åº“
            cp lib${{ github.event.repository.name }}.so ../../../mobile-releases/${{ matrix.platform }}/lib${{ github.event.repository.name }}-${{ matrix.arch }}.so
          fi

      - name: ä¸Šä¼ ç§»åŠ¨å¹³å°æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: mobile-${{ matrix.platform }}-${{ matrix.target }}
          path: mobile-releases/

  # Web å¹³å°æ„å»ºä½œä¸š
  web-build:
    name: ğŸŒ Web å¹³å°æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: wasm32-unknown-unknown
            optimize: true
            bindgen: true
          - target: wasm32-wasi
            optimize: true
            bindgen: false

    runs-on: ubuntu-latest
    needs: [security, workflow-validation, checks]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾å’Œ WASM å·¥å…·
        run: |
          rustup toolchain install stable
          rustup target add ${{ matrix.target }}
          rustup default stable

      - name: å®‰è£… WASM å·¥å…·é“¾
        run: |
          cargo install wasm-pack
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
          
      - name: å®‰è£… wasmtime (for WASI)
        if: matrix.target == 'wasm32-wasi'
        run: |
          curl https://wasmtime.dev/install.sh -sSf | bash
          echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH

      - uses: Swatinem/rust-cache@v2
        with:
          key: web-${{ matrix.target }}

      - name: æ„å»º WASM (wasm-pack)
        if: matrix.bindgen
        run: |
          wasm-pack build --target web --out-dir pkg-web --release
          wasm-pack build --target nodejs --out-dir pkg-node --release
          wasm-pack build --target bundler --out-dir pkg-bundler --release

      - name: æ„å»º WASM (cargo)
        if: '!matrix.bindgen'
        run: cargo build --release --target ${{ matrix.target }}

      - name: ä¼˜åŒ– WASM
        if: matrix.optimize
        run: |
          cargo install wasm-opt
          if [[ "${{ matrix.bindgen }}" == "true" ]]; then
            wasm-opt -Oz pkg-web/${{ github.event.repository.name }}_bg.wasm -o pkg-web/${{ github.event.repository.name }}_bg.wasm
            wasm-opt -Oz pkg-node/${{ github.event.repository.name }}_bg.wasm -o pkg-node/${{ github.event.repository.name }}_bg.wasm
            wasm-opt -Oz pkg-bundler/${{ github.event.repository.name }}_bg.wasm -o pkg-bundler/${{ github.event.repository.name }}_bg.wasm
          else
            wasm-opt -Oz target/${{ matrix.target }}/release/${{ github.event.repository.name }}.wasm -o target/${{ matrix.target }}/release/${{ github.event.repository.name }}.wasm
          fi

      - name: åˆ›å»º Web å‘å¸ƒåŒ…
        shell: bash
        run: |
          mkdir -p web-releases
          if [[ "${{ matrix.bindgen }}" == "true" ]]; then
            tar czvf web-releases/${{ github.event.repository.name }}-web.tar.gz pkg-web/
            tar czvf web-releases/${{ github.event.repository.name }}-node.tar.gz pkg-node/
            tar czvf web-releases/${{ github.event.repository.name }}-bundler.tar.gz pkg-bundler/
          else
            cd target/${{ matrix.target }}/release
            tar czvf ../../../web-releases/${{ github.event.repository.name }}-${{ matrix.target }}.tar.gz ${{ github.event.repository.name }}.wasm
          fi

      - name: ä¸Šä¼  Web æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: web-${{ matrix.target }}
          path: web-releases/

  # ç‰¹æ®Šå¹³å°æ„å»ºä½œä¸š (HarmonyOS ç­‰)
  special-build:
    name: ğŸ”® ç‰¹æ®Šå¹³å°æ„å»º (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # HarmonyOS (å®éªŒæ€§æ”¯æŒ)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-ohos
            platform: harmonyos
            experimental: true
          - os: ubuntu-latest
            target: x86_64-unknown-linux-ohos
            platform: harmonyos
            experimental: true

    runs-on: ${{ matrix.os }}
    needs: [security, workflow-validation, checks]
    continue-on-error: ${{ matrix.experimental }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install nightly
          rustup override set nightly
          
      - name: å°è¯•æ·»åŠ ç›®æ ‡å¹³å°
        continue-on-error: true
        run: rustup target add ${{ matrix.target }}

      - name: è®¾ç½® HarmonyOS å¼€å‘ç¯å¢ƒ
        if: matrix.platform == 'harmonyos'
        run: |
          echo "HarmonyOS æ”¯æŒä»åœ¨å®éªŒé˜¶æ®µ"
          echo "å½“å‰ä½¿ç”¨ Linux å·¥å…·é“¾è¿›è¡Œäº¤å‰ç¼–è¯‘"
          # è¿™é‡Œå¯ä»¥æ·»åŠ  HarmonyOS SDK çš„å®‰è£…å’Œé…ç½®

      - uses: Swatinem/rust-cache@v2
        with:
          key: special-${{ matrix.target }}

      - name: æ„å»ºç‰¹æ®Šå¹³å°é¡¹ç›®
        continue-on-error: ${{ matrix.experimental }}
        run: |
          if rustup target list --installed | grep -q ${{ matrix.target }}; then
            cargo build --release --target ${{ matrix.target }}
          else
            echo "ç›®æ ‡å¹³å° ${{ matrix.target }} æš‚ä¸å¯ç”¨ï¼Œè·³è¿‡æ„å»º"
          fi

      - name: ä¸Šä¼ ç‰¹æ®Šå¹³å°æ„å»ºäº§ç‰©
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: special-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/

  # æ„å»ºä½œä¸š - ä¿æŒå‘åå…¼å®¹
  build:
    name: ğŸ”— å…¼å®¹æ€§æ„å»º
    needs: [desktop-build, mobile-build, web-build, special-build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ„å»ºçŠ¶æ€æ±‡æ€»
        run: |
          echo "## ğŸ—ï¸ è·¨å¹³å°æ„å»ºå®ŒæˆçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ–¥ï¸ **æ¡Œé¢å¹³å°**: ${{ needs.desktop-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± **ç§»åŠ¨å¹³å°**: ${{ needs.mobile-build.result }}" >> $GITHUB_STEP_SUMMARY  
          echo "- ğŸŒ **Web å¹³å°**: ${{ needs.web-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”® **ç‰¹æ®Šå¹³å°**: ${{ needs.special-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ”¯æŒçš„å¹³å°" >> $GITHUB_STEP_SUMMARY
          echo "**æ¡Œé¢ç«¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (x86_64, aarch64, musl, i686)" >> $GITHUB_STEP_SUMMARY
          echo "- Windows (x86_64, i686, gnu)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (x86_64, Apple Silicon)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç§»åŠ¨ç«¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- iOS (è®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨)" >> $GITHUB_STEP_SUMMARY
          echo "- Android (ARM64, ARMv7, x86_64, x86)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Web ç«¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- WebAssembly (æµè§ˆå™¨å’Œ Node.js)" >> $GITHUB_STEP_SUMMARY
          echo "- WASI (æœåŠ¡å™¨ç«¯ WASM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰¹æ®Šå¹³å°:**" >> $GITHUB_STEP_SUMMARY
          echo "- HarmonyOS (å®éªŒæ€§æ”¯æŒ)" >> $GITHUB_STEP_SUMMARY

  # ä»£ç è´¨é‡åˆ†æ
  quality-analysis:
    name: ğŸ“Š ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…åˆ†æå·¥å…·
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete

      - name: æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
        run: cargo machete

      - name: ç”Ÿæˆä¾èµ–å›¾
        run: |
          cargo tree --format "{p} {f}" > dependency-tree.txt
          echo "ä¾èµ–æ ‘å·²ç”Ÿæˆ"

      - name: ä¸Šä¼ ä¾èµ–åˆ†æç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: dependency-analysis
          path: dependency-tree.txt

  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-review:
    name: ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

  # å‘å¸ƒä½œä¸š
  release:
    name: ğŸš€ åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [security, workflow-validation, checks, test, desktop-build, mobile-build, web-build, special-build, quality-analysis]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3

      - name: ç»„ç»‡å‘å¸ƒæ–‡ä»¶ç»“æ„
        run: |
          mkdir -p releases/{desktop,mobile,web,special}
          
          # æ•´ç†æ¡Œé¢å¹³å°æ–‡ä»¶
          find . -name "desktop-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* releases/desktop/ 2>/dev/null || true
            fi
          done
          
          # æ•´ç†ç§»åŠ¨å¹³å°æ–‡ä»¶
          find . -name "mobile-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* releases/mobile/ 2>/dev/null || true
            fi
          done
          
          # æ•´ç† Web å¹³å°æ–‡ä»¶
          find . -name "web-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* releases/web/ 2>/dev/null || true
            fi
          done
          
          # æ•´ç†ç‰¹æ®Šå¹³å°æ–‡ä»¶
          find . -name "special-*" -type d | while read dir; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* releases/special/ 2>/dev/null || true
            fi
          done

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        uses: orhun/git-cliff-action@v2
        id: git-cliff
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ğŸš€ è·¨å¹³å°å‘å¸ƒ
          
          æœ¬ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹å¹³å°ï¼š
          
          ### ğŸ–¥ï¸ æ¡Œé¢å¹³å°
          - **Linux**: x86_64, aarch64, musl, i686
          - **Windows**: x86_64, i686, GNU å·¥å…·é“¾
          - **macOS**: Intel å’Œ Apple Silicon
          
          ### ğŸ“± ç§»åŠ¨å¹³å°
          - **iOS**: è®¾å¤‡ (aarch64) å’Œæ¨¡æ‹Ÿå™¨ (x86_64, aarch64)
          - **Android**: ARM64, ARMv7, x86_64, x86
          
          ### ğŸŒ Web å¹³å°
          - **WebAssembly**: æµè§ˆå™¨ã€Node.jsã€æ‰“åŒ…å·¥å…·æ”¯æŒ
          - **WASI**: æœåŠ¡å™¨ç«¯ WebAssembly
          
          ### ğŸ”® å®éªŒæ€§å¹³å°
          - **HarmonyOS**: å®éªŒæ€§æ”¯æŒ (aarch64, x86_64)
          
          ---
          
          EOF
          cat CHANGES.md >> RELEASE_NOTES.md

      - name: åˆ›å»ºå¹³å°ç‰¹å®šçš„å‹ç¼©åŒ…
        run: |
          cd releases
          
          # åˆ›å»ºæ¡Œé¢å¹³å°å‹ç¼©åŒ…
          if [ -d "desktop" ] && [ "$(ls -A desktop)" ]; then
            tar czvf ../desktop-all-platforms.tar.gz desktop/
          fi
          
          # åˆ›å»ºç§»åŠ¨å¹³å°å‹ç¼©åŒ…
          if [ -d "mobile" ] && [ "$(ls -A mobile)" ]; then
            tar czvf ../mobile-all-platforms.tar.gz mobile/
          fi
          
          # åˆ›å»º Web å¹³å°å‹ç¼©åŒ…
          if [ -d "web" ] && [ "$(ls -A web)" ]; then
            tar czvf ../web-all-platforms.tar.gz web/
          fi
          
          # åˆ›å»ºç‰¹æ®Šå¹³å°å‹ç¼©åŒ…
          if [ -d "special" ] && [ "$(ls -A special)" ]; then
            tar czvf ../special-platforms.tar.gz special/
          fi

      - name: åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: |
            desktop-all-platforms.tar.gz
            mobile-all-platforms.tar.gz
            web-all-platforms.tar.gz
            special-platforms.tar.gz
            desktop-*/*
            mobile-*/*
            web-*/*
            special-*/*
          draft: false
          prerelease: false
          name: "Release ${{ github.ref_name }} - å…¨å¹³å°æ”¯æŒ"
