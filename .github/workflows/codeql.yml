# =============================================================================
# ðŸ” CodeQL å®‰å…¨åˆ†æžå·¥ä½œæµ
# =============================================================================
# GitHub CodeQL é™æ€ä»£ç åˆ†æžï¼Œä¸“é—¨ç”¨äºŽå®‰å…¨æ¼æ´žæ£€æµ‹
# ç‹¬ç«‹äºŽä¸»æž„å»ºæµç¨‹ï¼Œç¡®ä¿å®‰å…¨æ£€æŸ¥çš„å®Œæ•´æ€§å’Œä¸“ä¸šæ€§

name: "CodeQL å®‰å…¨åˆ†æž"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # æ¯å‘¨æ—¥ UTC 02:00 è¿è¡Œå®šæœŸå®‰å…¨æ‰«æ
    - cron: '0 2 * * 0'

permissions:
  actions: read
  contents: read
  security-events: write

# çŽ¯å¢ƒå˜é‡
env:
  CARGO_TERM_COLOR: always

jobs:
  # CodeQL åˆ†æžä½œä¸š
  analyze:
    name: ðŸ” CodeQL å®‰å…¨åˆ†æž
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'rust' ]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml
          
      - name: å®‰è£… Rust å·¥å…·é“¾
        run: |
          rustup toolchain install stable
          rustup default stable
          rustup component add rustfmt clippy

      - name: è®¾ç½® Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          key: codeql-analysis

      # è‡ªåŠ¨æž„å»ºå°è¯•ï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨æ‰‹åŠ¨æž„å»º
      - name: è‡ªåŠ¨æž„å»º
        uses: github/codeql-action/autobuild@v2
        continue-on-error: true
        id: autobuild

      # å¦‚æžœè‡ªåŠ¨æž„å»ºå¤±è´¥ï¼Œæ‰§è¡Œæ‰‹åŠ¨æž„å»º
      - name: æ‰‹åŠ¨æž„å»º (fallback)
        if: steps.autobuild.outcome == 'failure'
        run: |
          echo "è‡ªåŠ¨æž„å»ºå¤±è´¥ï¼Œæ‰§è¡Œæ‰‹åŠ¨æž„å»º..."
          cargo clean
          cargo build --all-targets --all-features --verbose

      - name: æ‰§è¡Œ CodeQL åˆ†æž
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{matrix.language}}"
          upload: true

  # åˆ†æžç»“æžœå¤„ç†
  results:
    name: ðŸ“Š åˆ†æžç»“æžœå¤„ç†
    runs-on: ubuntu-latest
    needs: analyze
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Šæ‘˜è¦
        run: |
          echo "## ðŸ” CodeQL å®‰å…¨åˆ†æžå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åˆ†æžè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **è¯­è¨€**: Rust" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æžæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æŸ¥çœ‹ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "è¯·å‰å¾€ [Security](https://github.com/${{ github.repository }}/security/code-scanning) é¡µé¢æŸ¥çœ‹è¯¦ç»†çš„å®‰å…¨åˆ†æžç»“æžœã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.analyze.result }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€**: åˆ†æžæˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€**: åˆ†æžè¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi 